<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Venus Liquidation</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body style="font-family: monospace; padding: 20px;">

<h2>Venus Liquidation Tool v2</h2>

<button onclick="connect()">1️⃣ Connect Wallet</button>
<br><br>

<button onclick="approveCRV()">2️⃣ Approve CRV</button>
<br><br>

<button onclick="liquidate()">3️⃣ Liquidate Borrower</button>

<pre id="log"></pre>

<script>
/* ========== CONFIG (YOU MUST SET THESE) ========== */

// ERC20 CRV token
const CRV_ADDRESS = "0xYOUR_CRV_ADDRESS";

// vCRV (borrowed market)
const VCRV_ADDRESS = "0x30aD10Bd5Be62CAb37863C2BfcC6E8fb4fD85BDa";

// vcrvUSD (collateral market)
const VCRVUSD_ADDRESS = "0x2d499800239C4CD3012473Cb1EAE33562F0A6933";

// Borrower address
const BORROWER = "0x15525dA6CD5Cf7c2aFab280477850ee9709464fD";

// Repay amount: 6 CRV
const REPAY_AMOUNT = ethers.utils.parseUnits("6.0", 18);

/* ========== ABIs (minimal) ========== */

const ERC20_ABI = [
  "function approve(address spender, uint256 amount) external returns (bool)",
  "function allowance(address owner, address spender) external view returns (uint256)"
];

const VCRV_ABI = [
  "function liquidateBorrow(address borrower, uint256 repayAmount, address vTokenCollateral) external"
];

/* ========== GLOBALS ========== */

let provider, signer;

/* ========== HELPERS ========== */

function log(msg) {
  document.getElementById("log").textContent += msg + "\n";
}

/* ========== ACTIONS ========== */

async function connect() {
  if (!window.ethereum) {
    alert("MetaMask required");
    return;
  }

  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();

  const addr = await signer.getAddress();
  log("Connected: " + addr);
}

async function approveCRV() {
  if (!signer) return alert("Connect wallet first");

  const crv = new ethers.Contract(CRV_ADDRESS, ERC20_ABI, signer);

  log("Sending approve...");
  const tx = await crv.approve(VCRV_ADDRESS, REPAY_AMOUNT);
  log("Approve tx sent: " + tx.hash);

  await tx.wait();
  log("Approve confirmed");
}

async function liquidate() {
  if (!signer) return alert("Connect wallet first");

  const vcrv = new ethers.Contract(VCRV_ADDRESS, VCRV_ABI, signer);

  try {
    log("Sending liquidation tx...");

    const tx = await vcrv.liquidateBorrow(
      BORROWER,
      REPAY_AMOUNT,
      VCRVUSD_ADDRESS
    );

    log("Tx submitted: " + tx.hash);

    const receipt = await tx.wait();

    if (receipt.status === 1) {
      log("✅ Liquidation confirmed");
    } else {
      log("❌ Tx mined but reverted");
    }

  } catch (err) {
    handleError(err);
  }
}

function handleError(err) {
  console.error(err);

  // User rejected tx
  if (err.code === 4001) {
    log("❌ User rejected transaction");
    return;
  }

  // Ethers v5 nested error
  if (err.error && err.error.message) {
    log("❌ Error: " + err.error.message);
    return;
  }

  // RPC revert reason
  if (err.data && err.data.message) {
    log("❌ Revert: " + err.data.message);
    return;
  }

  // Generic
  if (err.message) {
    log("❌ Error: " + err.message);
    return;
  }

  log("❌ Unknown error (check console)");
}
</script>

</body>
</html>
