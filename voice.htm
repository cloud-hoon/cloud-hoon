<input id="search" style="height:50px"/>
<input value="Voice" type="button" id="voiceSearch" onclick="reallyStop=false;recognition.start()" style="height:50px">
<input value="Abort" type="button" id="voiceAbort" onclick="stopListening()" style="height:50px">

<script>
var reallyStop=false;
var actions=['open','youtube','call','map','find'];
var grammars = '#JSGF V1.0; grammar colors; public <actions> = '+actions.join(' | ');
var recognition = new webkitSpeechRecognition()
var grammarList = new webkitSpeechGrammarList()
recognition.continuous = false;
recognition.interimResults = false;
grammarList.addFromString(grammars, 1);
recognition.grammars = grammarList;

function stopListening(){
	reallyStop=true;
	recognition.stop();
}
function processResult(result){
	var data=result.split(" ")
	index = actions.indexOf(data[0]);
	payload=result.substring(data[0].length+1)
	if(result=='stop listening' || result=='keep quiet' || result=='shut up'){
		result="I will stop listening"
		stopListening();
	}else if(index >= 0){
		if(data[0] == 'open'){
			
		}else if(data[0] == 'find' || data[0] = 'map'){
			result = "finding "+payload
			window.open("https://www.google.com.sg/search?q="+payload);
		}
	}else{
		result="What's "+result
	}
	
	return result;
}
//recognition.start();
recognition.onresult = function(e) {
	//console.log(e.results);
	//if(e.results[0][0].confidence < 0.7) return;
	result=e.results[0][0].transcript
	document.getElementById('search').value = result;
	result=processResult(result);
	speech= new SpeechSynthesisUtterance(result);
	speech.onend=function(){
		if(!reallyStop){
			recognition.start()
		}
	}
	window.speechSynthesis.speak(speech);
        recognition.stop();
	
        //setTimeout(function (){recognition.start()},1000)
      };
/*recognition.onspeechend=function(e){
	recognition.stop();
};*/
recognition.onerror = function(e) {
	//recognition.stop()
        console.log(e);
	//var msg = new SpeechSynthesisUtterance("Error:"+e.error);
	//window.speechSynthesis.speak(msg);
        if(!reallyStop){
		setTimeout(function (){recognition.start()},1000)
	}
};
recognition.start();
</script>
